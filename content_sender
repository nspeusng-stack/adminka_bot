import json
import logging
import aiosqlite
from aiogram.types import InputMediaPhoto, InputMediaVideo

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(
    level=logging.INFO,
    format="%(asctime)s %(levelname)s %(name)s: %(message)s"
)
logger = logging.getLogger(__name__)

DB_PATH = "bot.db"  # –∏–ª–∏ —á–∏—Ç–∞–π—Ç–µ –∏–∑ .env —á–µ—Ä–µ–∑ load_dotenv()

async def send_content_by_id(bot, chat_id: int, content_id: int):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç –∏–∑ —Ç–∞–±–ª–∏—Ü—ã content."""
    # 1) –ü–æ–ª—É—á–∞–µ–º –∑–∞–ø–∏—Å—å –∏–∑ –ë–î
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute(
            "SELECT type, data, caption, description FROM content WHERE id=?",
            (content_id,)
        ) as cur:
            row = await cur.fetchone()

    if not row:
        await bot.send_message(chat_id, "‚ùå –ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return

    ctype, raw_data, caption, description = row
    logger.info("send_content_by_id: id=%s type=%s raw_data=%s caption=%s",
                content_id, ctype, raw_data, caption)

    try:
        # 2) –ü—Ä–æ—Å—Ç—ã–µ —Ç–∏–ø—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞
        if ctype == "text":
            await bot.send_message(chat_id, raw_data)

        elif ctype == "link":
            label = caption or "–°—Å—ã–ª–∫–∞"
            await bot.send_message(chat_id, f"{label}: {raw_data}")

        elif ctype == "photo":
            await bot.send_photo(chat_id, raw_data, caption=caption)

        elif ctype == "video":
            await bot.send_video(chat_id, raw_data, caption=caption)

        elif ctype == "document":
            await bot.send_document(chat_id, raw_data, caption=caption)

        # üîπ –ù–æ–≤—ã–π –±–ª–æ–∫: –Ω–µ—Å–∫–æ–ª—å–∫–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        elif ctype == "documents_group":
            try:
                files = json.loads(raw_data)
            except json.JSONDecodeError as e:
                logger.error("JSON decode failed for documents_group: %s", e)
                return await bot.send_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –≥—Ä—É–ø–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.")

            sent_any = False
            for idx, item in enumerate(files):
                if (not isinstance(item, (list, tuple))) or len(item) != 2:
                    logger.warning("Invalid document item, skipping: %s", item)
                    continue

                kind, fid = item
                if kind == "document":
                    try:
                        await bot.send_document(chat_id, fid, caption=caption if idx == 0 else None)
                        sent_any = True
                    except Exception as e:
                        logger.error("Failed to send document %s: %s", fid, e)

            if not sent_any:
                return await bot.send_message(chat_id, "‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –≥—Ä—É–ø–ø–µ.")

        # 3) Media group (—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ)
        elif ctype == "media_group":
            try:
                files = json.loads(raw_data)
            except json.JSONDecodeError as e:
                logger.error("JSON decode failed for media_group: %s", e)
                return await bot.send_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–±–æ—Ä–∞ –º–µ–¥–∏–∞-–≥—Ä—É–ø–ø—ã.")

            media = []
            for idx, item in enumerate(files):
                if (not isinstance(item, (list, tuple))) or len(item) != 2:
                    logger.warning("Invalid media item, skipping: %s", item)
                    continue

                kind, fid = item
                args = {"caption": caption if idx == 0 else None}
                if kind == "photo":
                    media.append(InputMediaPhoto(media=fid, **args))
                elif kind == "video":
                    media.append(InputMediaVideo(media=fid, **args))
                else:
                    logger.warning("Unsupported media kind, skipping: %s", kind)

            if not media:
                return await bot.send_message(chat_id, "‚ùå –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö –º–µ–¥–∏–∞ –≤ –≥—Ä—É–ø–ø–µ.")

            try:
                await bot.send_media_group(chat_id, media)
            except Exception as e:
                logger.error("send_media_group failed: %s", e)
                for m in media:
                    try:
                        if isinstance(m, InputMediaPhoto):
                            await bot.send_photo(chat_id, m.media, caption=m.caption or "")
                        else:
                            await bot.send_video(chat_id, m.media, caption=m.caption or "")
                    except Exception as inner:
                        logger.error("Fallback send failed for %s: %s", m, inner)

        else:
            await bot.send_message(chat_id, "‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞.")

    except Exception as outer:
        logger.exception("Unexpected error in send_content_by_id")
        await bot.send_message(chat_id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.")

    # 4) –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
    if description:
        await bot.send_message(chat_id, description)
