# handlers/admin.py

import os
import json
import tempfile
from typing import Optional, List

import aiosqlite
from dotenv import load_dotenv

from aiogram import Router, types, F
from aiogram.filters import Command
from aiogram.fsm.state import StatesGroup, State
from aiogram.fsm.context import FSMContext
from aiogram.types import (
    InlineKeyboardMarkup,
    InlineKeyboardButton,
    InputMediaPhoto,
    InputMediaVideo,
    FSInputFile,
)
from aiogram.utils.keyboard import InlineKeyboardBuilder

from menu_cache import load_menu, get_section
from .user import build_menu

# -------------------------------------------------------------------
# Load configuration, initialize router
# -------------------------------------------------------------------
load_dotenv()
DB_PATH = os.getenv("DB_PATH", "bot.db")
admin_ids_str = os.getenv("ADMIN_IDS", "")
if not admin_ids_str:
    raise RuntimeError("ADMIN_IDS not set in .env")
ADMIN_IDS = [int(x.strip()) for x in admin_ids_str.split(",") if x.strip()]

router = Router()

# -------------------------------------------------------------------
# Helpers
# -------------------------------------------------------------------
def is_admin(user_id: int) -> bool:
    return user_id in ADMIN_IDS

def admin_main_menu() -> InlineKeyboardMarkup:
    kb = InlineKeyboardBuilder()
    kb.button(text="üì¢ –†–∞—Å—Å—ã–ª–∫–∞",     callback_data="admin:broadcast")
    kb.button(text="üìù –ö–æ–Ω—Ç–µ–Ω—Ç",      callback_data="admin:content")
    kb.button(text="üìã –ú–µ–Ω—é",         callback_data="admin:menu")
    kb.button(text="üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin:users")
    kb.button(text="üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞",   callback_data="admin:stats")
    kb.button(text="‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏",     callback_data="admin:settings")
    kb.button(text="üö™ –í—ã—Ö–æ–¥",        callback_data="admin:exit")
    kb.adjust(1)
    return kb.as_markup()

async def send_content_by_id(bot, chat_id: int, content_id: int):
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute(
            "SELECT type, data, caption, description FROM content WHERE id=?", (content_id,)
        ) as cur:
            row = await cur.fetchone()
    if not row:
        try: await bot.send_message(chat_id, "–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        except: pass
        return

    ctype, data, caption, description = row
    try:
        if ctype == "text":
            await bot.send_message(chat_id, data)
        elif ctype == "link":
            label = caption or "–°—Å—ã–ª–∫–∞"
            await bot.send_message(chat_id, f"{label}: {data}")
        elif ctype == "photo":
            await bot.send_photo(chat_id, data, caption=caption)
        elif ctype == "video":
            await bot.send_video(chat_id, data, caption=caption)
        elif ctype == "document":
            await bot.send_document(chat_id, data, caption=caption)
        elif ctype == "documents_group":
            try:
                files = json.loads(data)
            except Exception as e:
                return await bot.send_message(chat_id, f"–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≥—Ä—É–ø–ø—ã –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {e}")
            for kind, fid in files:
                if kind == "document":
                    await bot.send_document(chat_id, fid, caption=caption)    
        elif ctype == "media_group":
            try:
                files = json.loads(data)
            except:
                return await bot.send_message(chat_id, "–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –∞–ª—å–±–æ–º–∞.")
            media = []
            for idx, (kind, fid) in enumerate(files):
                if kind == "photo":
                    media.append(InputMediaPhoto(media=fid, caption=caption if idx==0 else None))
                elif kind == "video":
                    media.append(InputMediaVideo(media=fid, caption=caption if idx==0 else None))
            if media:
                await bot.send_media_group(chat_id, media)
            else:
                await bot.send_message(chat_id, "–ê–ª—å–±–æ–º –ø—É—Å—Ç –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—à–∏–±–∫–∏.")
        else:
            await bot.send_message(chat_id, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –∫–æ–Ω—Ç–µ–Ω—Ç–∞.")
    except:
        try: await bot.send_message(chat_id, "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.")
        except: pass

    if description:
        try: await bot.send_message(chat_id, description)
        except: pass

async def ensure_photo_file_id(bot, chat_id: int, doc: types.Document) -> str:
    f = await bot.get_file(doc.file_id)
    with tempfile.TemporaryDirectory() as td:
        path = os.path.join(td, doc.file_name or "image.jpg")
        await bot.download_file(f.file_path, destination=path)
        sent = await bot.send_photo(chat_id, FSInputFile(path))
        new_id = sent.photo[-1].file_id
        await bot.delete_message(chat_id, sent.message_id)
        return new_id

async def ensure_video_file_id(bot, chat_id: int, doc: types.Document) -> str:
    f = await bot.get_file(doc.file_id)
    with tempfile.TemporaryDirectory() as td:
        path = os.path.join(td, doc.file_name or "video.mp4")
        await bot.download_file(f.file_path, destination=path)
        sent = await bot.send_video(chat_id, FSInputFile(path))
        new_id = sent.video.file_id
        await bot.delete_message(chat_id, sent.message_id)
        return new_id

async def notify_admins_new_user(bot, user_id: int, username: Optional[str]):
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚úÖ –û–¥–æ–±—Ä–∏—Ç—å", callback_data=f"approve:{user_id}")],
        [InlineKeyboardButton(text="üö´ –û—Ç–∫–ª–æ–Ω–∏—Ç—å", callback_data=f"reject:{user_id}")],
    ])
    uname = f"@{username}" if username else "(–±–µ–∑ username)"
    for aid in ADMIN_IDS:
        try:
            await bot.send_message(aid, f"üÜï –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user_id} {uname}", reply_markup=kb)
        except:
            pass

def parse_roles_input(s: str) -> List[str]:
    parts = [p.strip() for p in s.split(",") if p.strip()]
    seen, out = set(), []
    for p in parts:
        if p not in seen:
            seen.add(p)
            out.append(p)
    return out

# -------------------------------------------------------------------
# FSM states
# -------------------------------------------------------------------
class BroadcastState(StatesGroup):
    roles = State()
    payload = State()

class ContentAddState(StatesGroup):
    waiting_message = State()
    waiting_description = State()
    waiting_role = State()

class MenuAddState(StatesGroup):
    section = State()
    text = State()
    kind = State()
    target = State()
    content_catch = State()
    content_description = State()
    position = State()
    visible_for = State()

class MenuListState(StatesGroup):
    section = State()

class MenuDeleteState(StatesGroup):
    button_id = State()

class UsersBanState(StatesGroup):
    user_id = State()

class UsersUnbanState(StatesGroup):
    user_id = State()

class UsersSetRoleState(StatesGroup):
    user_id = State()
    role = State()

class UsersSearchState(StatesGroup):
    query = State()

class UsersSmsState(StatesGroup):
    user_id = State()
    text = State()

class SettingsState(StatesGroup):
    value = State()

class EditButtonFSM(StatesGroup):
    waiting_for_button_id = State()
    waiting_for_field_choice = State()
    waiting_for_new_value = State()

# -------------------------------------------------------------------
# /admin entrypoint & exit
# -------------------------------------------------------------------
@router.message(Command("admin"))
async def cmd_admin(message: types.Message):
    if not is_admin(message.from_user.id):
        await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
        return
    await message.answer("‚úÖ –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å", reply_markup=admin_main_menu())

@router.callback_query(F.data == "admin:exit")
async def admin_exit(cb: types.CallbackQuery):
    await cb.message.edit_text("üö™ –í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")

# -------------------------------------------------------------------
# Live menu reload
# -------------------------------------------------------------------
@router.message(Command("reload_menu"))
async def reload_menu_cmd(message: types.Message):
    if not is_admin(message.from_user.id):
        return await message.answer("‚õî –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤.")
    await load_menu()

    root = get_section("root")
    if root:
        lines = ["‚úÖ –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ. –ö–Ω–æ–ø–∫–∏ –≤ —Å–µ–∫—Ü–∏–∏ root:"]
        for i, (txt, kind, tgt, cid) in enumerate(root, start=1):
            tail = tgt or (f"content:{cid}" if cid else "")
            lines.append(f"{i}. {txt} ‚Äî {kind} ‚Üí {tail}")
        report = "\n".join(lines)
    else:
        report = "‚úÖ –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω–æ, –Ω–æ –≤ —Å–µ–∫—Ü–∏–∏ root –Ω–µ—Ç –∫–Ω–æ–ø–æ–∫."

    kb = await build_menu("root")
    if kb:
        await message.answer(report, reply_markup=kb)
    else:
        await message.answer(report)

# -------------------------------------------------------------------
# Broadcast workflow
# -------------------------------------------------------------------
@router.callback_query(F.data == "admin:broadcast")
async def broadcast_start(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer(
        "–£–∫–∞–∂–∏—Ç–µ —Ä–æ–ª–∏ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏:\n"
        "- all (–≤—Å–µ –æ–¥–æ–±—Ä–µ–Ω–Ω—ã–µ –∏ –Ω–µ –∑–∞–±–∞–Ω–µ–Ω–Ω—ã–µ)\n"
        "- –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: seller,admin)"
    )
    await state.set_state(BroadcastState.roles)

@router.message(BroadcastState.roles)
async def broadcast_roles_set(message: types.Message, state: FSMContext):
    raw = message.text.strip().lower()
    await state.update_data(roles_raw=raw)
    await message.answer("–ü—Ä–∏—à–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç, —Å—Å—ã–ª–∫—É, —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç:")
    await state.set_state(BroadcastState.payload)

@router.message(BroadcastState.payload)
async def broadcast_send(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return

    data = await state.get_data()
    roles_raw = data["roles_raw"]

    payload = {"type": None}
    if message.text:
        text = message.text.strip()
        payload["type"] = "text"
        payload["text"] = text
    elif message.photo:
        payload["type"] = "photo"
        payload["file_id"] = message.photo[-1].file_id
        payload["caption"] = message.caption
    elif message.video:
        payload["type"] = "video"
        payload["file_id"] = message.video.file_id
        payload["caption"] = message.caption
    elif message.document:
        doc = message.document
        mt = (doc.mime_type or "").lower()
        if mt.startswith("image/"):
            fid = await ensure_photo_file_id(message.bot, message.chat.id, doc)
            payload["type"]    = "photo"
            payload["file_id"] = fid
            payload["caption"] = message.caption
        elif mt.startswith("video/"):
            fid = await ensure_video_file_id(message.bot, message.chat.id, doc)
            payload["type"]    = "video"
            payload["file_id"] = fid
            payload["caption"] = message.caption
        else:
            payload["type"]    = "document"
            payload["file_id"] = message.document.file_id
            payload["caption"] = message.caption
    else:
        return await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏.")

    recipients: List[int] = []
    async with aiosqlite.connect(DB_PATH) as db:
        if roles_raw == "all":
            q = "SELECT user_id FROM users WHERE approved=1 AND is_banned=0"
            args = ()
        else:
            roles = parse_roles_input(roles_raw)
            placeholders = ",".join("?" for _ in roles)
            q = (
                f"SELECT user_id FROM users "
                f"WHERE approved=1 AND is_banned=0 AND COALESCE(role,'seller') IN ({placeholders})"
            )
            args = roles
        async with db.execute(q, args) as cur:
            recipients = [r[0] for r in await cur.fetchall()]

    if not recipients:
        await message.answer("–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.")
        await state.clear()
        return

    sent = failed = 0
    for uid in recipients:
        try:
            if payload["type"] == "text":
                await message.bot.send_message(uid, payload["text"])
            elif payload["type"] == "photo":
                await message.bot.send_photo(uid, payload["file_id"], caption=payload.get("caption"))
            elif payload["type"] == "video":
                await message.bot.send_video(uid, payload["file_id"], caption=payload.get("caption"))
            elif payload["type"] == "document":
                await message.bot.send_document(uid, payload["file_id"], caption=payload.get("caption"))
            sent += 1
        except:
            failed += 1

    await message.answer(
        f"‚úÖ –†–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n"
        f"–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {len(recipients)}\n"
        f"–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: {sent}\n"
        f"–ù–µ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {failed}",
        reply_markup=admin_main_menu()
    )
    await state.clear()

# -------------------------------------------------------------------
# Content management
# -------------------------------------------------------------------
@router.callback_query(F.data == "admin:content")
async def content_add_intro(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer(
        "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞:\n"
        "- —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫–∞ (http/https)\n"
        "- —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–¥–æ–∫—É–º–µ–Ω—Ç\n\n"
        "–î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –∏—Ö –ø–æ –æ–¥–Ω–æ–º—É, –∑–∞—Ç–µ–º /done.\n"
        "–ü–æ—Å–ª–µ –ø—Ä–∏—ë–º–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —É–∫–∞–∂–µ—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏ —Ä–æ–ª–∏."
    )
    await state.set_state(ContentAddState.waiting_message)

# –ü—Ä–∏—ë–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ–º
@router.message(ContentAddState.waiting_message, F.document)
async def content_add_receive_document(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    data = await state.get_data()
    files = data.get("files", [])
    files.append(("document", message.document.file_id))
    await state.update_data(files=files)
    await message.answer(f"üìÑ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω ({len(files)} —à—Ç). –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â—ë –∏–ª–∏ /done –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.")

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
@router.message(ContentAddState.waiting_message, Command("done"))
async def content_add_done(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    data = await state.get_data()
    files = data.get("files", [])
    if not files:
        return await message.answer("–ù–µ—Ç —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.")
    if len(files) == 1:
        ctype, payload = files[0]
    else:
        ctype, payload = "documents_group", json.dumps(files)
    await state.update_data(ctype=ctype, data=payload, caption=None)
    await message.answer("–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∏–ª–∏ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):")
    await state.set_state(ContentAddState.waiting_description)

# –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –ø—Ä–∏—ë–º —Ç–µ–∫—Å—Ç–∞, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ
@router.message(ContentAddState.waiting_message)
async def content_add_capture(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    ctype = payload = caption = None
    if message.text:
        txt = message.text.strip()
        if txt.lower().startswith(("http://","https://")):
            ctype, payload = "link", txt
        else:
            ctype, payload = "text", txt
    elif message.photo:
        ctype, payload = "photo", message.photo[-1].file_id
        caption = message.caption
    elif message.video:
        ctype, payload = "video", message.video.file_id
        caption = message.caption
    # elif message.document:
    #     ctype, payload = "document", message.document.file_id
    #     caption = message.caption
    if not ctype:
        return await message.answer("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç.")
    await state.update_data(ctype=ctype, data=payload, caption=caption)
    await message.answer("–î–æ–±–∞–≤—å—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ (–∏–ª–∏ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):")
    await state.set_state(ContentAddState.waiting_description)

@router.message(ContentAddState.waiting_description)
async def content_add_description(message: types.Message, state: FSMContext):
    desc = message.text.strip()
    if desc == "-":
        desc = None
    await state.update_data(description=desc)
    await message.answer("–£–∫–∞–∂–∏—Ç–µ —Ä–æ–ª–∏ –¥–æ—Å—Ç—É–ø–∞ (all –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):")
    await state.set_state(ContentAddState.waiting_role)

@router.message(ContentAddState.waiting_role)
async def content_add_save(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    role = message.text.strip().lower() or "all"
    data = await state.get_data()
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO content(type, data, caption, description, role) VALUES(?,?,?,?,?)",
            (data["ctype"], data["data"], data.get("caption"), data.get("description"), role)
        )
        await db.commit()
        async with db.execute("SELECT last_insert_rowid()") as cur:
            cid = (await cur.fetchone())[0]
    await message.answer(f"‚úÖ –ö–æ–Ω—Ç–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω. ID: {cid}", reply_markup=admin_main_menu())
    await state.clear()

# -------------------------------------------------------------------
# User management
# -------------------------------------------------------------------
def users_menu() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üö´ –ë–∞–Ω –ø–æ ID",        callback_data="users:ban")],
        [InlineKeyboardButton(text="‚úÖ –†–∞–∑–±–∞–Ω –ø–æ ID",     callback_data="users:unban")],
        [InlineKeyboardButton(text="üé≠ –ù–∞–∑–Ω–∞—á–∏—Ç—å —Ä–æ–ª—å",   callback_data="users:setrole")],
        [InlineKeyboardButton(text="üìã –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", callback_data="users:list:1")],
        [InlineKeyboardButton(text="üîç –ü–æ–∏—Å–∫",            callback_data="users:search:?:1")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥",            callback_data="admin:root")],
    ])

@router.callback_query(F.data == "admin:users") 
async def users_root(cb: types.CallbackQuery): 
    if not is_admin(cb.from_user.id): 
        return 
    await cb.message.answer("üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏:", reply_markup=users_menu())
        
@router.callback_query(F.data == "admin:root")
async def admin_root(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return

    # –£–±–∏—Ä–∞–µ–º ¬´–∫—Ä—É—Ç–∏–ª–∫—É¬ª Telegram –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º FSM-—Å–æ—Å—Ç–æ—è–Ω–∏–µ
    await cb.answer()
    await state.clear()

    # –†–∏—Å—É–µ–º –≥–ª–∞–≤–Ω–æ–µ –∞–¥–º–∏–Ω-–º–µ–Ω—é
    # –ó–¥–µ—Å—å –º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    await cb.message.edit_text(
        text="üîß –ì–ª–∞–≤–Ω–æ–µ –∞–¥–º–∏–Ω-–º–µ–Ω—é:",
        reply_markup=admin_main_menu()
    )

@router.callback_query(F.data == "users:search:?:1")
async def users_search_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("üîç –í–≤–µ–¥–∏ username –∏–ª–∏ ID –¥–ª—è –ø–æ–∏—Å–∫–∞:")
    await state.set_state(UsersSearchState.query)

@router.message(UsersSearchState.query)
async def users_search_do(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    query = message.text.strip()
    await state.clear()

    fake_cb = types.CallbackQuery(
        id=0,
        from_user=message.from_user,
        chat_instance="",
        data=f"users:search:{query}:1",
        message=message
    )
    await users_list(fake_cb, state)

@router.callback_query(
    F.data.startswith("users:list") |
    F.data.startswith("users:search")
)
async def users_list(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return

    # –†–∞–∑–±–æ—Ä callback_data
    parts = cb.data.split(":", 3)
    mode = parts[1]
    if mode == "list":
        page = int(parts[2]) if parts[2].isdigit() else 1
        query = None
    else:
        query = parts[2]
        page = int(parts[3]) if len(parts) > 3 and parts[3].isdigit() else 1

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    page_size = 10
    offset = (page - 1) * page_size

    # –î–æ—Å—Ç–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    base_sql = """
        SELECT user_id, username, is_banned, approved,
               COALESCE(role,'seller') as role_norm
        FROM users
    """
    params: List = []
    if query:
        base_sql += " WHERE username LIKE ? OR user_id = ?"
        params += [f"%{query}%", int(query) if query.isdigit() else 0]
    base_sql += " ORDER BY created_at DESC LIMIT ? OFFSET ?"
    params += [page_size, offset]

    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute(base_sql, params) as cur:
            rows = await cur.fetchall()

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç
    if not rows:
        text = "–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ." if query else "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ—Ç."
        return await cb.message.answer(text, reply_markup=users_menu())

    # 1) –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
    lines = ["üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:"]
    for idx, (uid, uname, banned, approved, role_norm) in enumerate(rows):
        number = offset + idx + 1
        uname_str = f"@{uname}" if uname else "-"
        flags = []
        if banned:        flags.append("üö´ –±–∞–Ω")
        if not approved:  flags.append("‚è≥ –Ω–µ –æ–¥–æ–±—Ä–µ–Ω")
        if not flags:     flags.append("‚úÖ –æ–∫")
        lines.append(
            f"{number}. {uid} {uname_str} ‚Äî {', '.join(flags)} ‚Äî —Ä–æ–ª—å: {role_norm}"
        )
    text = "\n".join(lines)

    # 2) –°—Ç—Ä–æ–∏–º –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
    builder = InlineKeyboardBuilder()
    for idx, (uid, *_) in enumerate(rows):
        number = offset + idx + 1
        builder.row(
            InlineKeyboardButton(
                text=f"{number}. üö´",
                callback_data=f"users:ban:{uid}:{page}:{query or ''}"
            ),
            InlineKeyboardButton(
                text=f"{number}. üé≠",
                callback_data=f"users:setrole:{uid}:{page}:{query or ''}"
            ),
            InlineKeyboardButton(
                text=f"{number}. ‚úâÔ∏è",
                callback_data=f"users:sms:{uid}:{page}:{query or ''}"
            ),
        )

    # 3) –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º
    prev_page = max(1, page - 1)
    next_page = page + 1
    if query:
        builder.row(
            InlineKeyboardButton(
                text="‚óÄÔ∏è", 
                callback_data=f"users:search:{query}:{prev_page}"
            ),
            InlineKeyboardButton(text=str(page), callback_data="ignore"),
            InlineKeyboardButton(
                text="‚ñ∂Ô∏è", 
                callback_data=f"users:search:{query}:{next_page}"
            ),
        )
    else:
        builder.row(
            InlineKeyboardButton(
                text="‚óÄÔ∏è", 
                callback_data=f"users:list:{prev_page}"
            ),
            InlineKeyboardButton(text=str(page), callback_data="ignore"),
            InlineKeyboardButton(
                text="‚ñ∂Ô∏è", 
                callback_data=f"users:list:{next_page}"
            ),
        )

    # 4) –ü–æ–∏—Å–∫ –∏ –≤–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    builder.row(
        InlineKeyboardButton(text="üîç –ü–æ–∏—Å–∫", callback_data="users:search:?:1"),
        InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥",  callback_data="admin:users"),
    )

    kb = builder.as_markup()
    await cb.message.answer(text, reply_markup=kb)

# ---- –¥–∞–ª—å—à–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ----

@router.callback_query(F.data.startswith("users:ban:"))
async def users_ban_inline(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    _, _, sid, page, query = cb.data.split(":", 4)
    uid = int(sid)
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("UPDATE users SET is_banned=1 WHERE user_id=?", (uid,))
        await db.commit()
    await cb.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.", show_alert=True)
    await users_list(cb, state)

@router.callback_query(F.data == "users:ban")
async def users_ban_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("–£–∫–∞–∂–∏ user_id –¥–ª—è –±–∞–Ω–∞:")
    await state.set_state(UsersBanState.user_id)

@router.message(UsersBanState.user_id)
async def users_ban_do(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    try:
        uid = int(message.text.strip())
    except ValueError:
        return await message.answer("ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("UPDATE users SET is_banned=1 WHERE user_id=?", (uid,))
        await db.commit()
    await message.answer(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –∑–∞–±–∞–Ω–µ–Ω.", reply_markup=admin_main_menu())
    await state.clear()

@router.callback_query(F.data.startswith("users:unban:"))
async def users_unban_inline(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    _, _, sid, page, query = cb.data.split(":", 4)
    uid = int(sid)
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("UPDATE users SET is_banned=0 WHERE user_id=?", (uid,))
        await db.commit()
    await cb.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.", show_alert=True)
    await users_list(cb, state)

@router.callback_query(F.data == "users:unban")
async def users_unban_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("–£–∫–∞–∂–∏ user_id –¥–ª—è —Ä–∞–∑–±–∞–Ω–∞:")
    await state.set_state(UsersUnbanState.user_id)

@router.message(UsersUnbanState.user_id)
async def users_unban_do(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    try:
        uid = int(message.text.strip())
    except ValueError:
        return await message.answer("ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("UPDATE users SET is_banned=0 WHERE user_id=?", (uid,))
        await db.commit()
    await message.answer(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} —Ä–∞–∑–±–∞–Ω–µ–Ω.", reply_markup=admin_main_menu())
    await state.clear()

@router.callback_query(F.data.startswith("approve:"))
async def approve_user_cb(cb: types.CallbackQuery):
    if not is_admin(cb.from_user.id):
        return
    try:
        uid = int(cb.data.split(":",1)[1])
    except:
        return
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("UPDATE users SET approved=1 WHERE user_id=?", (uid,))
        await db.commit()
    await cb.message.edit_text(f"‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –æ–¥–æ–±—Ä–µ–Ω.")
    try:
        await cb.bot.send_message(uid,
            "‚úÖ –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ–¥–æ–±—Ä–µ–Ω. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ù–∞–∂–º–∏ /start"
        )
    except:
        pass
# 1. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ¬´—Å–º–µ–Ω—ã —Ä–æ–ª–∏¬ª
@router.callback_query(F.data.startswith("users:setrole:"))
async def users_setrole_start(cb: types.CallbackQuery, state: FSMContext):
    await cb.answer()
    parts = cb.data.split(":", 3)
    user_id = int(parts[2])
    await state.update_data(user_id=user_id)
    await state.set_state(UsersSetRoleState.role)
    await cb.message.answer(
        f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} (seller, office, nsy, admin, im):"
    )

@router.message(UsersSetRoleState.role)
async def users_setrole_finish(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data["user_id"]
    new_role = message.text.strip()

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "UPDATE users SET role = ? WHERE user_id = ?",
            (new_role, user_id)
        )
        await db.commit()

    await message.answer(f"–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id} –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ¬´{new_role}¬ª.")
    await state.clear()
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    await users_list(
        types.CallbackQuery(
            id=str(message.message_id),
            from_user=message.from_user,
            chat_instance="",
            data=f"users:list:1",  # –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º
            message=message
        ),
        state
    )


# 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ¬´–æ—Ç–ø—Ä–∞–≤–∫–∏ SMS¬ª
@router.callback_query(F.data.startswith("users:sms:"))
async def users_sms_start(cb: types.CallbackQuery, state: FSMContext):
    await cb.answer()
    parts = cb.data.split(":", 3)
    user_id = int(parts[2])
    await state.update_data(user_id=user_id)
    await state.set_state(UsersSmsState.text)
    await cb.message.answer(f"–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user_id}:")

@router.message(UsersSmsState.text)
async def users_sms_finish(message: types.Message, state: FSMContext):
    data = await state.get_data()
    user_id = data["user_id"]
    text = message.text

    try:
        await message.bot.send_message(chat_id=user_id, text=text)
        await message.answer("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ.")
    except Exception as e:
        await message.answer(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ: {e}")

    await state.clear()
    # –°–Ω–æ–≤–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
    await users_list(
        types.CallbackQuery(
            id=str(message.message_id),
            from_user=message.from_user,
            chat_instance="",
            data="users:list:1",
            message=message
        ),
        state
    )        

@router.callback_query(F.data.startswith("reject:"))
async def reject_user(cb: types.CallbackQuery):
    if not is_admin(cb.from_user.id):
        return
    try:
        uid = int(cb.data.split(":",1)[1])
    except:
        return
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("DELETE FROM users WHERE user_id=?", (uid,))
        await db.commit()
    await cb.message.edit_text(f"üö´ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {uid} –æ—Ç–∫–ª–æ–Ω—ë–Ω.")
    try:
        await cb.bot.send_message(uid, "‚ùå –í–∞—à –∞–∫–∫–∞—É–Ω—Ç –æ—Ç–∫–ª–æ–Ω—ë–Ω.")
    except:
        pass

# -------------------------------------------------------------------
# Statistics
# -------------------------------------------------------------------
@router.callback_query(F.data == "admin:stats")
async def admin_stats(cb: types.CallbackQuery):
    if not is_admin(cb.from_user.id):
        return
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute("SELECT COUNT(*) FROM users") as cur:
            total = (await cur.fetchone())[0]
        async with db.execute("SELECT COUNT(*) FROM users WHERE is_banned=1") as cur:
            banned = (await cur.fetchone())[0]
        async with db.execute("SELECT COUNT(*) FROM users WHERE approved=0") as cur:
            pending = (await cur.fetchone())[0]
        async with db.execute("""
            SELECT COALESCE(role,'seller') as r, COUNT(*) 
            FROM users GROUP BY r ORDER BY COUNT(*) DESC LIMIT 10
        """) as cur:
            by_role = await cur.fetchall()

    lines = [
        f"–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {total}",
        f"–ó–∞–±–∞–Ω–µ–Ω–æ: {banned}",
        f"–û–∂–∏–¥–∞—é—Ç –æ–¥–æ–±—Ä–µ–Ω–∏—è: {pending}",
        "",
        "–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–æ–ª—è–º (—Ç–æ–ø 10):"
    ]
    if by_role:
        lines += [f"- {r}: {c}" for r, c in by_role]
    else:
        lines.append("- –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö")

    await cb.message.answer("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n" + "\n".join(lines))

# -------------------------------------------------------------------
# Settings
# -------------------------------------------------------------------
from db import is_auto_approve_enabled, toggle_auto_approve

async def settings_menu() -> InlineKeyboardMarkup:
    """–°—Ç—Ä–æ–∏—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å –∞–∫—Ç—É–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞–≤—Ç–æ-–¥–æ—Å—Ç—É–ø–∞."""
    auto_state = await is_auto_approve_enabled()
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="üëã –ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ", callback_data="settings:greeting")],
        [InlineKeyboardButton(
            text=f"üîì –ê–≤—Ç–æ-–¥–æ—Å—Ç—É–ø: {'–í–ö–õ' if auto_state else '–í–´–ö–õ'}",
            callback_data="settings:auto_approve"
        )],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥", callback_data="admin:exit")]
    ])

@router.callback_query(F.data == "admin:settings")
async def settings_root(cb: types.CallbackQuery):
    """–û—Ç–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å —Ç–µ–∫—É—â–∏–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ–º –∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∞–≤—Ç–æ-–¥–æ—Å—Ç—É–ø–∞."""
    if not is_admin(cb.from_user.id):
        return
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute("SELECT value FROM settings WHERE key='greeting'") as cur:
            row = await cur.fetchone()
    current = row[0] if row else "(–Ω–µ –∑–∞–¥–∞–Ω–æ)"
    await cb.message.answer(
        f"–¢–µ–∫—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:\n{current}",
        reply_markup=await settings_menu()
    )

@router.callback_query(F.data == "settings:greeting")
async def settings_greeting_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("–í–≤–µ–¥–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è:")
    await state.set_state(SettingsState.value)

@router.message(SettingsState.value)
async def settings_greeting_set(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    val = message.text.strip()
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO settings(key,value) VALUES('greeting',?) "
            "ON CONFLICT(key) DO UPDATE SET value=excluded.value",
            (val,)
        )
        await db.commit()
    await message.answer("‚úÖ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ.", reply_markup=admin_main_menu())
    await state.clear()

@router.callback_query(F.data == "settings:auto_approve")
async def settings_toggle_auto_approve(cb: types.CallbackQuery):
    """–ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ñ–ª–∞–≥ –∞–≤—Ç–æ-–¥–æ—Å—Ç—É–ø–∞ –∏ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ—Ç –º–µ–Ω—é."""
    if not is_admin(cb.from_user.id):
        return
    new_state = await toggle_auto_approve()
    status = "–≤–∫–ª—é—á—ë–Ω ‚úÖ" if new_state else "–æ—Ç–∫–ª—é—á—ë–Ω ‚ùå"
    await cb.answer(f"–ê–≤—Ç–æ-–¥–æ—Å—Ç—É–ø —Ç–µ–ø–µ—Ä—å {status}", show_alert=True)

    # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –º–µ–Ω—é
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute("SELECT value FROM settings WHERE key='greeting'") as cur:
            row = await cur.fetchone()
    current = row[0] if row else "(–Ω–µ –∑–∞–¥–∞–Ω–æ)"
    await cb.message.edit_text(
        f"–¢–µ–∫—É—â–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:\n{current}",
        reply_markup=await settings_menu()
    )

# -------------------------------------------------------------------
# Menu management
# -------------------------------------------------------------------
def menu_manage_kb() -> InlineKeyboardMarkup:
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É",  callback_data="menu:add")],
        [InlineKeyboardButton(text="üìÑ –°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ —Ä–∞–∑–¥–µ–ª–∞", callback_data="menu:list")],
        [InlineKeyboardButton(text="‚úè –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–æ–ø–∫—É", callback_data="menu:edit_info")],
        [InlineKeyboardButton(text="‚ùå –£–¥–∞–ª–∏—Ç—å –∫–Ω–æ–ø–∫—É", callback_data="menu:delete")],
        [InlineKeyboardButton(text="üîô –ù–∞–∑–∞–¥",           callback_data="admin:exit")],
    ])

@router.callback_query(F.data == "admin:menu")
async def menu_root(cb: types.CallbackQuery):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ–Ω—é:", reply_markup=menu_manage_kb())

@router.callback_query(F.data == "menu:add")
async def menu_add_start(cb: types.CallbackQuery, state: FSMContext):
    await cb.message.answer("–£–∫–∞–∂–∏ —Ä–∞–∑–¥–µ–ª (–Ω–∞–ø—Ä–∏–º–µ—Ä: root):")
    await state.set_state(MenuAddState.section)

@router.message(MenuAddState.section)
async def menu_add_section(message: types.Message, state: FSMContext):
    await state.update_data(section=message.text.strip())
    await message.answer("–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:")
    await state.set_state(MenuAddState.text)

@router.message(MenuAddState.text)
async def menu_add_text(message: types.Message, state: FSMContext):
    await state.update_data(text=message.text.strip())
    kb = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–û—Ç–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª", callback_data="kind:open")],
        [InlineKeyboardButton(text="–ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç", callback_data="kind:content")],
        [InlineKeyboardButton(text="–û—Ç–∫—Ä—ã—Ç—å URL", callback_data="kind:url")],
    ])
    await message.answer(text="–í—ã–±–µ—Ä–∏ —Ç–∏–ø –∫–Ω–æ–ø–∫–∏:", reply_markup=kb)
    await state.set_state(MenuAddState.kind)

@router.callback_query(MenuAddState.kind, F.data.startswith("kind:"))
async def menu_add_choose_kind(cb: types.CallbackQuery, state: FSMContext):
    kind = cb.data.split(":", 1)[1]
    await state.update_data(kind=kind)
    if kind in ("open", "url"):
        prompt = "–†–∞–∑–¥–µ–ª –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è:" if kind == "open" else "–í—Å—Ç–∞–≤—å –ø–æ–ª–Ω—ã–π URL:"
        await cb.message.answer(prompt)
        await state.set_state(MenuAddState.target)
    else:
        await cb.message.answer(
            "–ü—Ä–∏—à–ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –∫–Ω–æ–ø–∫–∏:\n"
            "- —Ç–µ–∫—Å—Ç –∏–ª–∏ —Å—Å—ã–ª–∫–∞\n"
            "- —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ (–¥–ª—è –∞–ª—å–±–æ–º–∞ –æ—Ç–ø—Ä–∞–≤—å –Ω–µ—Å–∫–æ–ª—å–∫–æ, –∑–∞—Ç–µ–º /done)\n"
            "- –¥–æ–∫—É–º–µ–Ω—Ç"
        )
        await state.update_data(files=[])
        await state.set_state(MenuAddState.content_catch)

@router.message(MenuAddState.target)
async def menu_add_target(message: types.Message, state: FSMContext):
    await state.update_data(target=message.text.strip())
    await message.answer("–ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏ (—á–∏—Å–ª–æ, —á–µ–º –º–µ–Ω—å—à–µ ‚Äî —Ç–µ–º –≤—ã—à–µ):")
    await state.set_state(MenuAddState.position)

@router.message(MenuAddState.content_catch, Command("done"))
async def menu_add_media_done(message: types.Message, state: FSMContext):
    data = await state.get_data()
    files = data.get("files") or []

    # –ï—Å–ª–∏ —Ñ–∞–π–ª–æ–≤ –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –≤—ã–≤–æ–¥–∏–º
    if not files:
        return await message.answer("–ê–ª—å–±–æ–º –ø—É—Å—Ç.")

    # –ï—Å–ª–∏ –æ–¥–∏–Ω —Ñ–∞–π–ª
    if len(files) == 1:
        kind, fid = files[0]

        if kind == "document":
            # –¥–∞–∂–µ –æ–¥–∏–Ω–æ—á–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–¥—ë—Ç –∫–∞–∫ documents_group
            await state.update_data(
                ctype="documents_group",
                payload=json.dumps(files),
                caption=None,
                files=[]
            )
        else:
            await state.update_data(
                ctype=kind,
                payload=fid,
                caption=None,
                files=[]
            )

    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤
    else:
        first_kind = files[0][0]

        if first_kind == "document":
            await state.update_data(
                ctype="documents_group",
                payload=json.dumps(files),
                caption=None,
                files=[]
            )
        else:
            await state.update_data(
                ctype="media_group",
                payload=json.dumps(files),
                caption=None,
                files=[]
            )

    await message.answer("–î–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ (–∏–ª–∏ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):")
    await state.set_state(MenuAddState.content_description)

@router.message(MenuAddState.content_catch, F.photo)
async def menu_add_receive_photo(message: types.Message, state: FSMContext):
    files = (await state.get_data()).get("files", [])
    files.append(("photo", message.photo[-1].file_id))
    await state.update_data(files=files)
    await message.answer("üì∑ –§–æ—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ. /done –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.")

@router.message(MenuAddState.content_catch, F.video)
async def menu_add_receive_video(message: types.Message, state: FSMContext):
    files = (await state.get_data()).get("files", [])
    files.append(("video", message.video.file_id))
    await state.update_data(files=files)
    await message.answer("üé• –í–∏–¥–µ–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ. /done –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.")

@router.message(MenuAddState.content_catch, F.document)
async def menu_add_receive_document(message: types.Message, state: FSMContext):
    # –ü–æ–ª—É—á–∞–µ–º —É–∂–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    files = (await state.get_data()).get("files", [])
    # –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–æ–∫
    files.append(("document", message.document.file_id))
    await state.update_data(files=files)
    # –°–æ–æ–±—â–∞–µ–º –∞–¥–º–∏–Ω—É –∏ –æ—Å—Ç–∞—ë–º—Å—è –≤ —Ç–æ–º –∂–µ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë
    await message.answer("üìÑ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω. –û—Ç–ø—Ä–∞–≤—å –µ—â—ë –∏–ª–∏ /done –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.")

@router.message(MenuAddState.content_catch, F.text & ~F.text.startswith("/"))
async def menu_add_receive_text(message: types.Message, state: FSMContext):
    txt = message.text.strip()
    if txt.lower().startswith(("http://", "https://")):
        await state.update_data(ctype="link", payload=txt, caption=None)
    else:
        await state.update_data(ctype="text", payload=txt, caption=None)
    await message.answer("–î–æ–±–∞–≤—å –æ–ø–∏—Å–∞–Ω–∏–µ (–∏–ª–∏ '-' —á—Ç–æ–±—ã –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):")
    await state.set_state(MenuAddState.content_description)

@router.message(MenuAddState.content_description)
async def menu_add_content_description(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return

    desc = message.text.strip()
    if desc == "-":
        desc = None

    data = await state.get_data()
    ctype = data.get("ctype")
    payload = data.get("payload")
    caption = data.get("caption")

    files = data.get("files")
    if not ctype and isinstance(files, list) and files:
        if len(files) == 1:
            kind, fid = files[0]
            if kind == "document":
                ctype, payload = "documents_group", json.dumps(files)
            else:
                ctype, payload = kind, fid
        else:
            first_kind = files[0][0]
            if first_kind == "document":
                ctype, payload = "documents_group", json.dumps(files)
            else:
                ctype, payload = "media_group", json.dumps(files)
        await state.update_data(files=[])

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO content(type, data, caption, description, role) VALUES(?,?,?,?,?)",
            (ctype, payload, caption, desc, "all")
        )
        await db.commit()
        async with db.execute("SELECT last_insert_rowid()") as cur:
            content_id = (await cur.fetchone())[0]

    await state.update_data(content_id=content_id)
    await message.answer("–ü–æ–∑–∏—Ü–∏—è –∫–Ω–æ–ø–∫–∏ (—á–∏—Å–ª–æ, —á–µ–º –º–µ–Ω—å—à–µ ‚Äî —Ç–µ–º –≤—ã—à–µ):")
    await state.set_state(MenuAddState.position)

@router.message(MenuAddState.position)
async def menu_add_ask_visible_for(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    try:
        pos = int(message.text.strip())
    except ValueError:
        return await message.answer("–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ.")
    await state.update_data(position=pos)
    await message.answer("–†–æ–ª–∏ –¥–ª—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ (all –∏–ª–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):")
    await state.set_state(MenuAddState.visible_for)

@router.message(MenuAddState.visible_for)
async def menu_add_finish(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return

    vis = message.text.strip().lower() or "all"
    data = await state.get_data()

    section     = data.get("section")
    text        = data.get("text")
    kind        = data.get("kind")
    target      = data.get("target")
    content_id  = data.get("content_id")
    position    = data.get("position")

    if not section or not text or not kind or position is None:
        return await message.answer(
            "‚ùóÔ∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ /menu_add"
        )

    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute(
            "INSERT INTO menu_buttons("
              "section, text, type, target, content_id, position, visible_for"
            ") VALUES(?,?,?,?,?,?,?)",
            (
                section,
                text,
                kind,
                target,
                content_id,
                position,
                vis
            )
        )
        await db.commit()

    await load_menu()
    await message.answer("‚úÖ –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞.", reply_markup=admin_main_menu())
    await state.clear()

# ---- List buttons ----
@router.callback_query(F.data == "menu:list")
async def menu_list_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("–£–∫–∞–∂–∏ —Ä–∞–∑–¥–µ–ª –¥–ª—è —Å–ø–∏—Å–∫–∞:")
    await state.set_state(MenuListState.section)

@router.message(MenuListState.section)
async def menu_list_show(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    sec = message.text.strip()
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute("""
            SELECT id,text,type,COALESCE(target,''),COALESCE(content_id,0),
                   position,COALESCE(visible_for,'all')
            FROM menu_buttons WHERE section=? ORDER BY position,id
        """, (sec,)) as cur:
            rows = await cur.fetchall()

    if not rows:
        await message.answer("–ù–µ—Ç –∫–Ω–æ–ø–æ–∫ –≤ —Ä–∞–∑–¥–µ–ª–µ.")
    else:
        lines = [f"–ö–Ω–æ–ø–∫–∏ '{sec}':"]
        for bid, txt, kind, tgt, cid, pos, vis in rows:
            tail = tgt or (f"content:{cid}" if cid else "")
            lines.append(f"[{bid}] ({pos}) {txt} ‚Äî {kind}‚Üí{tail} ‚Äî vis:{vis}")
        await message.answer("\n".join(lines))
    await state.clear()

# ---- Delete button ----
@router.callback_query(F.data == "menu:delete")
async def menu_delete_ask(cb: types.CallbackQuery, state: FSMContext):
    if not is_admin(cb.from_user.id):
        return
    await cb.message.answer("–£–∫–∞–∂–∏ ID –∫–Ω–æ–ø–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:")
    await state.set_state(MenuDeleteState.button_id)

@router.message(MenuDeleteState.button_id)
async def menu_delete_do(message: types.Message, state: FSMContext):
    if not is_admin(message.from_user.id):
        return
    try:
        bid = int(message.text.strip())
    except:
        return await message.answer("ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
    async with aiosqlite.connect(DB_PATH) as db:
        await db.execute("DELETE FROM menu_buttons WHERE id=?", (bid,))
        await db.commit()
    await load_menu()
    await message.answer("‚úÖ –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∞.", reply_markup=admin_main_menu())
    await state.clear()
    await state.clear()


# ---- Edit info (–ø–æ–ª–Ω—ã–π CRUD —Å visible_for, content, description) ----

def field_choice_kb() -> InlineKeyboardMarkup:
    """
    –§–æ—Ä–º–∏—Ä—É–µ—Ç Inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –≤—ã–±–æ—Ä–æ–º –ø–æ–ª—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.
    –ö–∞–∂–¥–∞—è –∫–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç callback_data –≤–∏–¥–∞ "field:<–∏–º—è_–ø–æ–ª—è>".
    """
    kb = InlineKeyboardBuilder()
    # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∫–Ω–æ–ø–∫–∏
    kb.button(text="–¢–µ–∫—Å—Ç",       callback_data="field:text")
    kb.button(text="–¢–∏–ø",         callback_data="field:type")
    kb.button(text="Target",      callback_data="field:target")
    kb.button(text="Content ID",  callback_data="field:content_id")
    kb.button(text="Position",    callback_data="field:position")
    kb.button(text="Visible For", callback_data="field:visible_for")
    # –ù–æ–≤—ã–µ –ø–æ–ª—è: –∫–æ–Ω—Ç–µ–Ω—Ç –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
    kb.button(text="Content",     callback_data="field:content")
    kb.button(text="Description", callback_data="field:description")
    # –†–∞–∑–º–µ—â–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ 2 –≤ —Ä—è–¥
    kb.adjust(2)
    return kb.as_markup()


@router.callback_query(F.data == "menu:edit_info")
async def menu_edit_start(
    cb: types.CallbackQuery,
    state: FSMContext
):
    """
    –®–∞–≥ 1. –ó–∞–ø—É—Å–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏.
    - –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ‚Äî –∞–¥–º–∏–Ω.
    - –ü—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ ID –∫–Ω–æ–ø–∫–∏.
    - –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è ID.
    """
    if not is_admin(cb.from_user.id):
        return

    await cb.message.answer(
        "–í–≤–µ–¥–∏—Ç–µ ID –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Å–Ω–∞—á–∞–ª–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ üìÑ —Å–ø–∏—Å–æ–∫):"
    )
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM: –∂–¥–µ–º ID –∫–Ω–æ–ø–∫–∏
    await state.set_state(EditButtonFSM.waiting_for_button_id)


@router.message(EditButtonFSM.waiting_for_button_id)
async def menu_edit_choose_field(
    message: types.Message,
    state: FSMContext
):
    """
    –®–∞–≥ 2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å—ã–ª–∞–µ—Ç ID –∫–Ω–æ–ø–∫–∏.
    - –ü–∞—Ä—Å–∏–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ —á–∏—Å–ª–æ.
    - –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î.
    - –°–æ—Ö—Ä–∞–Ω—è–µ–º button_id –≤ FSM –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –≤—ã–±—Ä–∞—Ç—å –ø–æ–ª–µ.
    """
    if not is_admin(message.from_user.id):
        return

    # –ü—Ä–æ–±—É–µ–º –ø—Ä–∏–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –∫ —á–∏—Å–ª—É
    try:
        bid = int(message.text.strip())
    except ValueError:
        return await message.answer("ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–Ω–æ–ø–∫–∞ —Å —Ç–∞–∫–∏–º ID —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    async with aiosqlite.connect(DB_PATH) as db:
        async with db.execute(
            "SELECT COUNT(1) FROM menu_buttons WHERE id = ?",
            (bid,)
        ) as cur:
            exists = (await cur.fetchone())[0]

    if not exists:
        return await message.answer("–ö–Ω–æ–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID:")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π ID –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ FSM
    await state.update_data(button_id=bid)

    # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–µ–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    await message.answer(
        f"–ö–Ω–æ–ø–∫–∞ [{bid}] –≤—ã–±—Ä–∞–Ω–∞. –ß—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º?",
        reply_markup=field_choice_kb()
    )
    # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—è
    await state.set_state(EditButtonFSM.waiting_for_field_choice)


@router.callback_query(
    EditButtonFSM.waiting_for_field_choice,
    F.data.startswith("field:")
)
async def menu_edit_wait_value(
    cb: types.CallbackQuery,
    state: FSMContext
):
    """
    –®–∞–≥ 3. –ê–¥–º–∏–Ω –Ω–∞–∂–∞–ª –Ω–∞ –æ–¥–Ω—É –∏–∑ –∫–Ω–æ–ø–æ–∫ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—è.
    - –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–º—è –ø–æ–ª—è (field).
    - –í—ã—Å—ã–ª–∞–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ –≤–≤–µ—Å—Ç–∏.
    - –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–∂–∏–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è.
    """
    if not is_admin(cb.from_user.id):
        return

    # –ò–∑ callback_data –∏–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è –ø–æ–ª—è –ø–æ—Å–ª–µ "field:"
    field = cb.data.split(":", 1)[1]
    allowed = {
        "text", "type", "target", "content_id",
        "position", "visible_for", "content", "description"
    }
    if field not in allowed:
        # –ó–∞—â–∏—Ç–∞ –Ω–∞ —Å–ª—É—á–∞–π –Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        return await cb.message.answer("–ü–æ–ª–µ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.")

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª–µ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ FSM –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
    await state.update_data(field=field)

    # –ü–æ–¥—Å–∫–∞–∑–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è ‚Äî —á—Ç–æ –≤–≤–µ—Å—Ç–∏ –¥–∞–ª—å—à–µ
    hints = {
        "text":        "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏:",
        "type":        "–ù–æ–≤—ã–π —Ç–∏–ø: open | content | url",
        "target":      "–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ target (—Ä–∞–∑–¥–µ–ª –∏–ª–∏ URL), –∏–ª–∏ '-' —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å:",
        "content_id":  "–ù–æ–≤—ã–π Content ID (—á–∏—Å–ª–æ) –∏–ª–∏ '-' —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å:",
        "position":    "–ù–æ–≤–∞—è –ø–æ–∑–∏—Ü–∏—è (—á–∏—Å–ª–æ):",
        "visible_for": "–ù–æ–≤–∞—è –≤–∏–¥–∏–º–æ—Å—Ç—å (all –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):",
        "content":     "–ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç (—Ç–µ–∫—Å—Ç, markdown –∏–ª–∏ file_id), –∏–ª–∏ '-' —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å:",
        "description": "–ù–æ–≤—ã–π —Ç–µ–∫—Å—Ç –æ–ø–∏—Å–∞–Ω–∏—è (tooltip) –∫–Ω–æ–ø–∫–∏, –∏–ª–∏ '-' —á—Ç–æ–±—ã –æ—á–∏—Å—Ç–∏—Ç—å:"
    }
    # –ü—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
    await cb.message.answer(hints[field])
    # –°–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è: –∂–¥–µ–º –≤–≤–æ–¥–∞ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
    await state.set_state(EditButtonFSM.waiting_for_new_value)


@router.message(EditButtonFSM.waiting_for_new_value)
async def menu_edit_apply_value(
    message: types.Message,
    state: FSMContext
):
    """
    –®–∞–≥ 4. –ê–¥–º–∏–Ω –≤–≤–æ–¥–∏—Ç –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
    - –í—ã—Ç–∞—Å–∫–∏–≤–∞–µ–º –∏–∑ FSM button_id –∏ field.
    - –í–∞–ª–∏–¥–∏—Ä—É–µ–º —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–æ–ª—è.
    - –ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ (NULL), –∏–Ω–∞—á–µ –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ.
    - –í—ã–ø–æ–ª–Ω—è–µ–º UPDATE –≤ —Ç–∞–±–ª–∏—Ü–µ menu_buttons.
    - –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à –º–µ–Ω—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∞–¥–º–∏–Ω–∞.
    - –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM.
    """
    if not is_admin(message.from_user.id):
        return

    data = await state.get_data()
    bid = data["button_id"]   # ID —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–π –∫–Ω–æ–ø–∫–∏
    field = data["field"]     # –∏–º—è –ø–æ–ª—è, –∫–æ—Ç–æ—Ä–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º
    raw = message.text.strip()  # —Å—ã—Ä–æ–π –≤–≤–æ–¥ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    update_value = None  # —Å—é–¥–∞ –ø–æ–ª–æ–∂–∏–º –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    nullable = False     # —Ñ–ª–∞–≥ ‚Äî –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ, –µ—Å–ª–∏ True

    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—è —Å–≤–æ—è –ª–æ–≥–∏–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
    if field == "text":
        # –¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º
        if not raw:
            return await message.answer("–¢–µ–∫—Å—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ —Å–Ω–æ–≤–∞:")
        update_value = raw

    elif field == "type":
        # –î–æ–ø—É—Å–∫–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –≤–∞—Ä–∏–∞–Ω—Ç–∞
        val = raw.lower()
        if val not in {"open", "content", "url"}:
            return await message.answer("–¢–∏–ø –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å open, content –∏–ª–∏ url.")
        update_value = val

    elif field == "target":
        # '-' –æ—á–∏—â–∞–µ—Ç –ø–æ–ª–µ, –∏–Ω–∞—á–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç—Ä–æ–∫—É
        if raw == "-":
            nullable = True
        else:
            update_value = raw

    elif field == "content_id":
        # '-' –æ—á–∏—â–∞–µ—Ç –ø–æ–ª–µ, –∏–Ω–∞—á–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —á–∏—Å–ª–æ
        if raw == "-":
            nullable = True
        else:
            try:
                update_value = int(raw)
            except ValueError:
                return await message.answer("Content ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º.")

    elif field == "position":
        # –ü–æ–∑–∏—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º
        try:
            update_value = int(raw)
        except ValueError:
            return await message.answer("–ü–æ–∑–∏—Ü–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")

    elif field == "visible_for":
        # all –∏–ª–∏ —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
        val = raw.lower()
        if val != "all":
            roles = [r.strip() for r in val.split(",") if r.strip()]
            if not roles:
                return await message.answer("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ä–æ–ª–µ–π.")
            val = ",".join(roles)
        update_value = val

    elif field in {"content", "description"}:
        # –î–ª—è –ø–æ–ª–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏—è '-' –æ—á–∏—â–∞–µ—Ç, –∏–Ω–∞—á–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º —Å—Ç—Ä–æ–∫—É
        if raw == "-":
            nullable = True
        else:
            update_value = raw

    # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ –ë–î: –ª–∏–±–æ –æ–±–Ω—É–ª—è–µ–º –ø–æ–ª–µ, –ª–∏–±–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
    async with aiosqlite.connect(DB_PATH) as db:
        if update_value is None and nullable:
            # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª–µ –≤ NULL
            await db.execute(f"UPDATE menu_buttons SET {field} = NULL WHERE id = ?", (bid,))
        else:
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
            await db.execute(f"UPDATE menu_buttons SET {field} = ? WHERE id = ?", (update_value, bid))
        await db.commit()

    # –û–±–Ω–æ–≤–ª—è–µ–º –∫—ç—à –º–µ–Ω—é, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ä–∞–∑—É –æ—Ç—Ä–∞–∑–∏–ª–∏—Å—å –≤ –±–æ—Ç–µ
    await load_menu()

    # –°–æ–æ–±—â–∞–µ–º –æ–± —É—Å–ø–µ—Ö–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –∞–¥–º–∏–Ω-–º–µ–Ω—é
    await message.answer("‚úÖ –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.", reply_markup=admin_main_menu())

    # –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ FSM, –∑–∞–≤–µ—Ä—à–∞—è –ø—Ä–æ—Ü–µ—Å—Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    await state.clear()
